<template>
    <v-card class="mx-auto main-container mb-2" elevation="6">
        <v-layout class="pr-3 pl-3" row wrap>
            <v-flex :class="[isMobile ? 'd-flex' : 'wrap']"
                    class="main-image-container justify-sm-center justify-center justify-md-start"
                    md5
                    sm6
                    xs12
            >
                <v-carousel class="main-image-container"
                            cycle
                            height="320px"
                            show-arrows-on-hover>
                    <v-card flat tile>
                        <v-carousel-item
                                :key="i"
                                v-for="(image,i) in this.images"
                        >
                            <v-img :src="image.src"
                                   @error="image.errorHandler"
                                   class="main-image"
                            ></v-img>
                        </v-carousel-item>
                    </v-card>
                </v-carousel>

                <OpenMapComponent :center="marker"
                                  :content="content"
                                  :height="'320px'"
                                  :marker="marker"
                                  class="mt-1"
                                  v-if="!isMobile"
                ></OpenMapComponent>
            </v-flex>
            <v-flex class="main-image-container justify-sm-center justify-center justify-md-start"
                    md7
                    sm6
                    wrap
                    xs12
            >
                <v-card-title class="headline text-start">
                    {{formattedCost}}
                </v-card-title>

                <v-card-subtitle class="text-start">
                    {{formattedSquareCost}}/м<sup>2</sup>
                </v-card-subtitle>

                <v-card-title class="text-start">
                    Характеристики
                </v-card-title>
                <v-content :key="i"
                           v-for="(qualification, i) in qualifications">
                    <v-card-subtitle class="text-start font-weight-bold">
                        {{qualification.title}}
                    </v-card-subtitle>

                    <v-layout :key="j"
                              :ripple="false"
                              row
                              v-for="(subQualification, j) in qualification.values">
                        <v-flex md4 sm4 xs5>
                            <v-card-text class="text-start ml-4 mt-0 mb-0"
                                         v-text="subQualification.title"></v-card-text>
                        </v-flex>
                        <v-flex md8 sm8 xs7>
                            <v-card-text class="text-start ml-4 mt-0 mb-0"
                                         v-text="subQualification.content"></v-card-text>
                        </v-flex>
                    </v-layout>
                </v-content>
            </v-flex>
            <v-card-title class="text-start">
                Описание
            </v-card-title>
            <v-card-text class="text-start">
                {{this.flat.description}}
            </v-card-text>
            <OpenMapComponent :center="marker"
                              :content="content"
                              :height="'300px'"
                              :marker="marker"
                              v-if="isMobile"
            ></OpenMapComponent>
        </v-layout>
    </v-card>
</template>

<script>
    import {mapActions, mapGetters} from "vuex";
    import OpenMapComponent from '../components/OpenMapComponent'
    import {MEDIA_HOST} from "../../config";

    export default {
        name: "FlatDetails",

        components: {OpenMapComponent,},

        data() {
            return {
                errorImages: null,
                errorMainImage: null,
                errorLayout: null,

                marker: [0, 0],
                content: null,
            }
        },

        mounted() {
            this.setFlatId(this.$route.params.flatId);
            this.getFlat();
        },

        methods: {
            ...mapActions('flatDetails', [
                'setFlatId',
                'getFlat'
            ]),

            onErrorMainImageLoading() {
                this.errorMainImage = true;
            },

            onErrorImagesLoading() {
                this.errorImages = true;
            },

            onErrorLayoutLoading() {
                this.errorLayout = true;
            },
        },

        computed: {
            ...mapGetters('flatDetails', [
                'flat',
                'currentFlatId',
            ]),

            formattedSquareCost() {
                return new Intl.NumberFormat('ru-RU', {
                    style: 'currency', currency: 'RUB', maximumFractionDigits: 0, minimumFractionDigits: 0,
                }).format(Math.round(this.flat.cost / this.flat.square));
            },

            formattedCost() {
                return new Intl.NumberFormat('ru-RU', {
                    style: 'currency', currency: 'RUB', maximumFractionDigits: 0, minimumFractionDigits: 0,
                }).format(Math.round(this.flat.cost));
            },

            noImage() {
                return require('@/assets/img/no-image.png');
            },

            mainImage() {
                return this.errorMainImage || !this.flat.main_image_thumbnail ? null : `${MEDIA_HOST}${this.flat.main_image_thumbnail}`;
            },

            layoutImage() {
                return this.errorLayout || !this.flat.layout_thumbnail ? null : `${MEDIA_HOST}${this.flat.layout_thumbnail}`;
            },

            images() {
                return [
                    {src: this.mainImage, errorHandler: this.onErrorMainImageLoading},
                    {src: this.layoutImage, errorHandler: this.onErrorLayoutLoading}
                ].filter(image => {
                    if (image.src) return image
                });
            },

            isMobile() {
                return this.$vuetify.breakpoint.name === 'xs';
            },

            qualifications() {
                return [{
                    title: 'О квартире', values: [
                        {title: 'Общая площадь', content: `${this.flat.square} м.кв.`},
                        {title: 'Комнатнасть', content: this.flat.flat_type},
                        {title: 'Этаж/Этажность', content: `${this.flat.floor} из ${this.flat.max_floor}`},
                    ],
                }, {
                    title: 'О доме', values: [
                        {title: 'Стены', content: this.flat.wall_material},
                        {title: 'Застройщик', content: this.flat.developer},
                        {title: 'Жилой комплекс', content: this.flat.residential_complex},
                        {title: 'Срок сдачи', content: `${this.flat.year_of_completion} ${this.flat.quarter}`},
                    ]
                }
                ];
            },
        },

        watch: {
            flat: function () {
                this.content = `${this.flat.city}, ${this.flat.street} ${this.flat.house}`
                this.center = [this.flat.longitude, this.flat.latitude]
                this.marker = [this.flat.longitude, this.flat.latitude];
            },
        },
    }
</script>

<style scoped>

    .main-image-container {
        width: 480px;
        height: auto;
    }

    .main-image {
        width: 480px;
        height: 100%;
    }

    .thumbnail-container {
        width: 240px;
        height: auto;
    }

    .thumbnails-container {
        height: auto;
    }

    .map-container {
        height: auto;
        width: 100%;
    }

    .main-container {
        max-width: 984px;
    }
</style>
